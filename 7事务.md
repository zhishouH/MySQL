## 事务
>事务的概念
- 在MySQL环境中，事务作为独立单元由一条或多条SQL语句组成。这个单元格中的每条SQL语句是相互依赖的，而且单元作为一个整体是不可分割的。如果单元中的一条语句不能完成，整个单元就会回滚，所有影响到的数据将返回到事务开始以前的状态。因而，只有事务中的所有语句都成功地执行才能说明这个事务被成功地执行。
- 例如：将公司的一名员工从一个部门转到另一个部门  ![事务概念例子](事务_1.png)

>事务的四大特性

>> 1.原子性
- 原子性意味着每个事务都必须被看作是一个不可分割的单元。假设一个事务由两个或多个任务组成，其中的语句必须同时成功才能认为整个事务是成功的。如果事务失败，系统将会返回到该事务以前的状态。
- 在员工转部门这个例子中，原子性指如果没有实现将部门表中原部门人数减一或新部门加一，就不可能将一个员工转部门。
>>2.一致性
- 一致性是指事务必须使数据库从一个一致性状态变换到另一个一致性状态，也就是说一个事务在执行之前和执行之后都必须处于一致性的状态。参照前面的例子，一致性是指如果员工转部门不成功，那部门人数不能发送改变，要保证数据的一致性
>>3.隔离性
- 隔离性是指每个事务在它自己的空间发生，和其他发生在系统中的事务隔离，而且事务的结果只有在它完全被执行时才能看到。即使在这样的一个系统中同时发生了多个事务，隔离性原则保证某个特定事务在完全完成之前，其结果是看不见的。对于任意两个并发的事务S1和S2来说，在事务S2要么在事务S1开始之前就已经结束，要么在事务S1之后才开始，这样每个事务都感觉不到有其他事务在并发执行。
>>4.持久性
- 持久性是指即使系统崩溃，一个提交的事务仍然存在。当一个事务完成，数据库的日志已经被更新时，持久性就开始发生作用。大多数RDBMS产品通过保存所有行为的日志来保证数据的持久性，这些行为是指在数据库中任何方法更改数据。数据库日志记录了所有对于表的更新、查询、报表等操作。

>事务处理
- 在MySQL中，但一个会话开始时，系统变量auto commit的值为1，即自动提交功能是打开的，当用户每执行一条SQL语句后，该语句对数据库的修改就立即被提交成为持久性修改保存到磁盘上，一个事务也就结束了。因此，用户必须关闭自动提交，事务才能由多条SQL语句组成，使用如下语句：
- set autocommit = 0;
- 执行此语句后，必须明确地指示每个事务地终止，事务中的SQL语句对数据库所作做的修改才能成为持久性修改。例如，执行如下语句：
```
update emp set deptno='d002' where id=1;
update dept set dcount=dcount-1 where deptno='d001';
update dept set dcount=dcount+1 where deptno='d002';
select * from emp;
select * from dept;
```
>> 1.开始事务
- 当一个应用程序的第一条SQ语句或者在commit或rollback语句后的第一条语句SQL执行后，一个新的事务也就开始了。另外还可以使用一条start transaction语句来显示地启动一个事务。
```
语法格式：
    start transaction | begin work
一条begin work语句可以用来替代start transaction语句，但是start transaction更常用。
```

>> 2.提交事务
- commit语句是提交语句，它使得自从事务开始以来所执行的所有数据修改成为数据库的永久部分，也标志一个事务的结束。
- 注意：MySQL使用的是平面事务模型，因此嵌套的事务是不允许的。在第一个事务里使用start transaction命令后，当第二个事务开始时，自动地提交第一个事务。同样，下面的这些MySQL语句运行时都会隐式地执行一个commit命令：
- drop database / drop table
- create index / drop index
- alter table / rename table
- lock tables / unlock tables
- set atuocommit = 1

>>3.回滚事务
- rollback语句是回滚语句，它撤销事务所做地修改，并结束当前这个事务。
- 在前面的举例中，若在最后加上以下这条语句：
```
    rollback;
执行完这条语句后，前面的修改动作将被回滚，可以使用select语句查看该行数据是否还原。
```