## 存储过程
>一、存储过程概述
- 存储过程(Stored Procedure)是一种在数据库中存储复杂程序，以便外部程序调用的一种数据库对象。
- 存储过程是为了完成特定功能的SQL语句集，经编译创建并保存在数据库中，用户可通过指定存储过程的名字并给定参数(需要时)来调用执行。
- 存储过程思想上很简单，就是数据库SQL语言层面的代码封装与重用。

|特点|
|:---|
|1、存储过程可封装，隐藏复杂的商业逻辑|
|2、存储过程可以回传值，并可以接受参数|
|3、存储过程无法使用select指令来运行，因为它是子程序，与查看表、数据或用户定义函数不同|
|4、存储过程可以用在数据检验，强制实现商业逻辑等|

|不足|
|:---|
|1、存储过程，往往定制化于特定的数据库上，因为支持的编程语言不同。当切换到其他厂商的数据库系统时，需要重写原有的存储过程|
|2、存储过程的性能调校与撰写，受限于各种数据库系统|

>二、存储过程的优点
- 1、存储过程在服务器端运行，执行速度快。

- 2、存储过程执行一次后，其执行代码就驻留在高速缓冲存储器，在以后的操作中，只需要高速缓冲器中调用已编译好的二进制代码执行，提高了系统性能。

- 3、确保数据库安全。使用存储过程可以完成所有数据库操作，并可通过编程方式控制上述操作对数据库信息访问的权限。

>三、存储过程创建、查询、修改与删除

>>(一)、创建
- 语法格式：
```
create procedure 存储过程名称(in | out | inout 参数名称 数据类型，...)
begin
  过程体；
end
```
- 说明：
- (1)、当存储过程有多个参数的时候中间用逗号隔开。MySQL存储过程支持三种类型的参数：输入参数、输出参数和输入/输出参数，关键字分别是in、out和inout。
- (2)、过程体中包含需要执行的语句，例如：DML、DDL语句，IF-THEN-ELSE和WHILE-DO语句，以及申明变量的DECLARE语句等。

- 例1、用存储过程获取19软件4班的人数。
```
delimiter //
create procedure getStuNum()
begin
  select count(*) as num from tb_student where classname = '19软件4班'；
end // 
delimiter ;
```

- 例2、用存储过程创建班级表，并往班级表中添加几条记录。
```
delimiter //
create procedure createClassT()
begin
 create table tb_class(
 classname varchar(30) primary key,
 cdept varchar(30) default"计算机与工程信息学院",
 aname varchar(10) not null,
 atel char(11));
 insert into tb_class value('17软件1班','计算机与信息工程学院','罗佳','15929765462');
 insert into tb_class value('18软件2班','计算机与信息工程学院','郭星','15929765462');
 insert into tb_class value('19测绘1班','测绘遥感信息学院','陈翔','15947474747');
 insert into tb_class value('19测绘2班','测绘遥感信息学院','陈翔','15947474747');
 insert into tb_class value('19软件1班','计算机与信息工程学院','罗佳','15929765462');
end //
delimiter ;
```

>>(二)、查询
- 1、查看所有存储过程状态：
```
show procedure status;
```

- 2、查看对应数据库下所有存储过程状态：
```
show procedure status where db = '数据库名';
```

- 3、查看名称包含Student的存储过程状态：
```
show procedure status where name like '%Student%';
```

- 4、查询存储过程详细代码：
```
show create procedure 过程名;
```

>>(三)、修改
- 使用alter procedure语句可以修改存储过程的某些特征。
```
语法格式：
alter procedure 存储过程[特征...]
特征=：
{contains sql | no sql | reads sql data | modifies sql data}
| sql security {definer | invoker}
|comment 'string'

注意：alter procedure语句只能修改存储过程的特征，而不能修改参数及过程体。
```

>>(四)、删除
- 存储过程创建后需要删除时使用drop procedure语句，在此之前，必须确认该过程没有任何依赖关系，否则会导致其他与之关联的存储过程无法运行。
```
语法格式：
drop procedure [if exists] 存储过程名
```
- 例：删除存储过程中getStuNum。
```
drop procedure if exists getStuNum;
```

>四、存储过程的调用
```
语法格式：
call 存储过程名([参数...])
```
- 例：创建存储过程，实现查询tb_student表中学生人数的功能。
```
use stumarkdb;
create procedure do_query()
    select count(*) num from tb_student;
调用该储存过程：
call do_query();
```

>五、参数
- MySQL存储过程的参数一共有三种：in、out和inout。
```
语法格式：
create procedure 存储过程名称(in | out | inout 参数名称 数据类型,...)
```
|参数|说明|
|:--:|:--:|
|in|输入参数，表示必须在调用存储过程时传入该参数，在存储过程中修改该参数的值不能被返回，in为默认类型|
|out|输出参数，该参数值可在存储过程内部被改变，值可以返回|
|inout|输入输出参数，在调用时指定，并且可被改变和返回|

>>in参数
- 例：用存储过程实现删除一个特定学生的信息。
```
delimiter //
create procedure delOneStu(in sid char(7))
begin
  delete from tb_student where sno = sid;
end //
delimiter ;
```

```
delimiter //
create procedure delOneStudent(in sno char(7))
begin
  delete from tb_student where tb_student.sno = sno;
end //
delimiter ;
当参数名与字段名相同时，要在字段名前面加上表名。
```
```
调用：call delOneStu('2019013')
```

>>out参数
- 例：用存储过程实现输出参数返回一个特定学生的姓名。
```
delimiter //
create procedure getStuName(in sno char(7),out sname varchar(10))
begin
  select s.sname into sname from tb_student s where s.sno = sno;
end //
delimiter ;
call getStuName('2019001',@aname);
```
```
select @aname;
```
- in类型的参数可以用常量赋值，但是在调用存储过程时必须为out类型的参数传入一个用户变量。在MySQL中用户变量以@开头，其作用域为本次会话结束前。

>>inout参数
- 例：用存储过程实现传入两个整数，返回较大的数。
```
1、
delimiter //
create procedure getBig(in snamllN int,inout bigN int)
begin
  if smallN > bigN then set bigN = smallN;
  end if;
end //
```
